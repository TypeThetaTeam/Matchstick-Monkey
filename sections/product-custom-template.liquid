{% comment %}
------------------------------------------------------------------------------
Custom Product Template Section
Shows product title, price, variant picker, and colour swatches
based entirely on tag images (tag_product-handle.png).
------------------------------------------------------------------------------
{% endcomment %}

<section class="ProductCustom container">
  <div class="ProductCustom__Inner">

    <!-- Product Title -->
    <h1 class="ProductCustom__Title">{{ product.title }}</h1>

    <!-- Product Price -->
    <div class="ProductCustom__Price">
      {% assign variant = product.selected_or_first_available_variant %}
      {% if variant.compare_at_price > variant.price %}
        <span class="ProductCustom__Price--Sale">{{ variant.price | money }}</span>
        <span class="ProductCustom__Price--Compare">{{ variant.compare_at_price | money }}</span>
      {% else %}
        <span class="ProductCustom__Price--Regular">{{ variant.price | money }}</span>
      {% endif %}
    </div>

    <!-- Product Form -->
    {%- form 'product', product, class: 'ProductCustom__Form', id: 'CustomProductForm' -%}
      <input type="hidden" name="id" value="{{ variant.id }}">

   
      <!-- Colour Swatches -->
{% assign product_tags = product.tags | join:',' %}
{% if product_tags contains 'product_' %}
  <div class="ProductCustom__ColorSwatches">
    <span class="ProductForm__Label">Colour:</span>
    <ul class="ColorSwatchList HorizontalList HorizontalList--spacingTight">
      {% assign prd_url = product.url | split:'/' | last %}
      {% for i in (1..100) %}
        {% for tag in product.tags %}
          {% if tag contains 'product_' %}
            {% assign number = tag | split:'_' | first | plus:0 %}
            {% if number == i %}
              {% assign p-tag = tag | split:'_' | last %}
              {% assign color_name = p-tag | replace: '-', ' ' | capitalize %}
              {% assign color_swatch_name = 'tag_' | append: p-tag | append: '.png' %}

              <li class="HorizontalList__Item {% if prd_url == p-tag %}current{% endif %}">
                <a href="/products/{{ p-tag }}" class="ColorSwatchLink" title="{{ color_name }}">
                  <span class="ColorSwatch"
                        style="background-image: url({{ color_swatch_name | asset_url }});">
                  </span>
                  <span class="ColorSwatch__Tooltip">{{ color_name }}</span>
                </a>
              </li>
            {% endif %}
          {% endif %}
        {% endfor %}
      {% endfor %}
    </ul>
  </div>
{% endif %}

      <!-- Variant Selector -->
      {% if product.variants.size > 1 %}
        <div class="ProductCustom__Variants">
          <label for="variant-select">Select Option:</label>
          <select id="variant-select" name="id">
            {% for variant in product.variants %}
              <option value="{{ variant.id }}" {% if variant == product.selected_or_first_available_variant %}selected{% endif %} {% unless variant.available %}disabled{% endunless %}>
                {{ variant.title }} - {{ variant.price | money }}
              </option>
            {% endfor %}
          </select>
        </div>
      {% endif %}

      <!-- Quantity -->
      <div class="ProductCustom__Qty">
        <label for="quantity">Quantity:</label>
        <input type="number" id="quantity" name="quantity" value="1" min="1">
      </div>

      <!-- AJAX Add to Cart -->
      <button type="submit"
        id="CustomAddToCartBtn"
        class="ProductCustom__AddToCart Button {% unless product.available %}disabled{% endunless %}"
        {% if product.available %}data-action="add-to-cart"{% else %}disabled{% endif %}>
        {% if product.available %}
          Buy Now â€“ {{ variant.price | money }}
        {% else %}
          Sold Out
        {% endif %}
      </button>
    {%- endform -%}
  </div>
</section>

<!-- AJAX Cart Script -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('CustomProductForm');
  const btn = document.getElementById('CustomAddToCartBtn');
  if (!form || !btn) return;

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    btn.disabled = true;
    btn.textContent = 'Adding...';

    const formData = new FormData(form);

    try {
      const response = await fetch('/cart/add.js', {
        method: 'POST',
        body: formData
      });

      if (response.ok) {
        btn.textContent = 'Added!';
        setTimeout(() => {
          btn.textContent = 'Buy Now';
          btn.disabled = false;
        }, 1500);
      } else {
        const data = await response.json();
        btn.textContent = data.message || 'Error';
        btn.disabled = false;
      }
    } catch (error) {
      btn.textContent = 'Error';
      btn.disabled = false;
    }
  });
});
</script>

<style>
  .ProductCustom { padding: 40px 20px; max-width: 700px; margin: 0 auto; }
  .ProductCustom__Title { font-size: 2rem; margin-bottom: 10px; text-transform: capitalize; }
  .ProductCustom__Price { font-size: 1.3rem; margin-bottom: 20px; }
  .ProductCustom__Price--Compare { text-decoration: line-through; margin-left: 8px; color: #999; }

  /* Swatch list */
  .ColorSwatchList { display: flex; gap: 12px; list-style: none; padding: 0; margin: 15px 0; flex-wrap: wrap; }
  .ColorSwatchLink { position: relative; display: inline-block; }
  .ColorSwatch {
    display: block;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: 1px solid #ccc;
    background-size: cover;
    background-position: center;
    cursor: pointer;
    transition: transform 0.2s ease, border 0.2s ease;
  }
  .ColorSwatchLink:hover .ColorSwatch {
    transform: scale(1.08);
    border: 2px solid #000;
  }
  .HorizontalList__Item.current .ColorSwatch { border: 2px solid #000; }

  /* Tooltip on hover */
  .ColorSwatch__Tooltip {
    position: absolute;
    bottom: -28px;
    left: 50%;
    transform: translateX(-50%);
    background: #111;
    color: #fff;
    font-size: 12px;
    padding: 3px 6px;
    border-radius: 3px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
  }
  .ColorSwatchLink:hover .ColorSwatch__Tooltip { opacity: 1; }

  /* Add to cart */
  .ProductCustom__AddToCart {
    width: 100%;
    padding: 12px;
    font-size: 1rem;
    margin-top: 15px;
    cursor: pointer;
  }

  .ProductCustom__Qty { margin-top: 15px; }
  .ProductCustom__Qty input { width: 60px; text-align: center; }
</style>
