{%- comment -%}
  Product custom snippet — gallery, lightbox, thumbnails, USPs, accordions
  Updated: Modern Liquid syntax, improved structure
  Modified: Added tag-based color swatches from Shopify Files
  Redesigned: New layout matching Figma design
  V2: Thumbnail customizer options, mobile swipe, price fix
{%- endcomment -%}

{%- liquid
  assign section_id = section_id | default: section.id | default: 'product-snippet'
  assign first_media = product.media | first
  assign ratio = 1
  
  if first_media and first_media.preview_image and first_media.preview_image.aspect_ratio
    assign ratio = first_media.preview_image.aspect_ratio
  elsif product.featured_image and product.featured_image.aspect_ratio
    assign ratio = product.featured_image.aspect_ratio
  endif
  
  assign show_thumbnails = section.settings.show_thumbnails
  assign thumbnail_position = section.settings.thumbnail_position
-%}

<section 
  id="product-custom-{{ section_id }}" 
  class="product-custom" 
  data-section-id="{{ section_id }}" 
  data-product-handle="{{ product.handle }}"
  data-thumb-position="{{ thumbnail_position }}"
>
  <div class="product__container">
    <!-- Gallery -->
    <div class="product__media {% if show_thumbnails %}has-thumbs thumbs-{{ thumbnail_position }}{% endif %}">
      
      {%- if show_thumbnails -%}
        <!-- Thumbnails (Desktop only - position based on setting) -->
        <div class="media-thumbs-desktop" id="MediaThumbsDesktop-{{ section_id }}" aria-label="Thumbnails">
          <button class="thumbs-arrow-desktop thumbs-arrow-desktop--prev" type="button" aria-label="Scroll thumbnails" hidden>
            <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true">
              {%- if thumbnail_position == 'left' or thumbnail_position == 'right' -%}
                <path d="M4.5 15.5 12 8l7.5 7.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              {%- else -%}
                <path d="M15.5 4.5 8 12l7.5 7.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              {%- endif -%}
            </svg>
          </button>
          <div class="thumbs-scroll-desktop">
            {%- for media in product.media -%}
              <button
                class="thumb-desktop{% if forloop.first %} is-active{% endif %}"
                data-target-index="{{ forloop.index0 }}"
                aria-controls="MediaMain-{{ section_id }}"
                aria-label="Show media {{ forloop.index }}"
              >
                <img 
                  loading="lazy" 
                  decoding="async" 
                  src="{{ media | image_url: width: 80, height: 80, crop: 'center' }}" 
                  alt="{{ media.alt | escape }}"
                  width="80"
                  height="80"
                >
              </button>
            {%- endfor -%}
          </div>
          <button class="thumbs-arrow-desktop thumbs-arrow-desktop--next" type="button" aria-label="Scroll thumbnails" hidden>
            <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true">
              {%- if thumbnail_position == 'left' or thumbnail_position == 'right' -%}
                <path d="M4.5 8.5 12 16l7.5-7.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              {%- else -%}
                <path d="M8.5 4.5 16 12l-7.5 7.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              {%- endif -%}
            </svg>
          </button>
        </div>
      {%- endif -%}

      <div class="media-main" id="MediaMain-{{ section_id }}" aria-live="polite">
        <div class="media-stage" style="--pc-aspect: {{ ratio | default: 1 }};">
          {%- for media in product.media -%}
            {%- liquid
              assign is_first = forloop.first
              assign loading_attr = 'lazy'
              assign fetchpriority_attr = ''
              
              if forloop.first
                assign loading_attr = 'eager'
                assign fetchpriority_attr = 'fetchpriority="high"'
              endif
            -%}
            
            <div
              class="media-slide{% if is_first %} is-active{% endif %}{% if media.media_type == 'image' %} is-image{% endif %}"
              data-media-id="{{ media.id }}"
              data-index="{{ forloop.index0 }}"
              role="group"
              aria-roledescription="slide"
              aria-label="{{ forloop.index }} of {{ product.media.size }}"
            >
              {%- case media.media_type -%}
                {%- when 'image' -%}
                  <img
                    class="zoom-target"
                    draggable="false"
                    loading="{{ loading_attr }}"
                    {{ fetchpriority_attr }}
                    decoding="async"
                    src="{{ media | image_url: width: 1600 }}"
                    srcset="
                      {{ media | image_url: width: 480 }} 480w,
                      {{ media | image_url: width: 800 }} 800w,
                      {{ media | image_url: width: 1200 }} 1200w,
                      {{ media | image_url: width: 1600 }} 1600w,
                      {{ media | image_url: width: 2000 }} 2000w"
                    sizes="(max-width: 989px) 100vw, 60vw"
                    alt="{{ media.alt | escape }}"
                    width="{{ media.preview_image.width }}"
                    height="{{ media.preview_image.height }}"
                  >
                {%- when 'external_video' -%}
                  {{ media | external_video_tag }}
                {%- when 'video' -%}
                  {{ media | video_tag: controls: true, muted: false, loop: false, preload: 'metadata' }}
                {%- when 'model' -%}
                  {{ media | model_viewer_tag }}
                {%- else -%}
                  <img 
                    draggable="false" 
                    loading="lazy" 
                    decoding="async" 
                    src="{{ media | image_url: width: 1600 }}" 
                    alt="{{ media.alt | escape }}"
                  >
              {%- endcase -%}
            </div>
          {%- endfor -%}

          <!-- Navigation arrows (desktop) -->
          <button class="pc-arrow pc-arrow--prev" type="button" aria-label="Previous image">
            <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
              <path d="M15.5 4.5 8 12l7.5 7.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
          <button class="pc-arrow pc-arrow--next" type="button" aria-label="Next image">
            <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
              <path d="M8.5 4.5 16 12l-7.5 7.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>

        <!-- Dots (mobile) -->
        <div class="media-dots" id="MediaDots-{{ section_id }}" aria-label="Slide indicators">
          {%- for media in product.media -%}
            <button 
              class="dot{% if forloop.first %} is-active{% endif %}" 
              data-target-index="{{ forloop.index0 }}" 
              aria-label="Go to image {{ forloop.index }}" 
              aria-controls="MediaMain-{{ section_id }}"
            ></button>
          {%- endfor -%}
        </div>
      </div>
    </div>

    <!-- Info -->
    <div class="product__info">
      <!-- Title Row -->
      <h1 class="product__title">{{ product.title }}</h1>
      
      <!-- Price Row -->
      {%- assign selected_variant = product.selected_or_first_available_variant -%}
      <div class="product__price" id="price-{{ section_id }}" role="status" aria-live="polite">
        {%- if selected_variant.compare_at_price and selected_variant.compare_at_price > selected_variant.price -%}
          <!-- On Sale: Show compare price (strikethrough) + current price -->
          <span class="price__compare">{{ selected_variant.compare_at_price | money }}</span>
          <span class="price__regular price__regular--sale">{{ selected_variant.price | money }}</span>
        {%- else -%}
          <!-- Not on Sale: Show regular price only -->
          <span class="price__regular">{{ selected_variant.price | money }}</span>
        {%- endif -%}
      </div>
      
      <!-- Judge.me Reviews -->
      <div class='jdgm-widget jdgm-preview-badge'>
        {{ product.metafields.judgeme.badge }}
      </div>

      <!-- Product Description -->
      {%- if product.description != blank -%}
        <div class="product__description">
          {{ product.description }}
        </div>
        <a href="#" class="see-more-link" id="see-more-{{ section_id }}">See More</a>
      {%- endif -%}

      {%- comment -%} USP list from metafields {%- endcomment -%}
      {%- liquid
        assign has_usp_list = false
        assign usp_items = blank
        
        if product.metafields.custom.usps and product.metafields.custom.usps.value != blank
          assign has_usp_list = true
          assign usps_raw = product.metafields.custom.usps.value | default: ''
          assign usp_items = usps_raw | split: ','
        elsif product.metafields.custom.usp_list and product.metafields.custom.usp_list.value != blank
          assign has_usp_list = true
          assign usp_items = product.metafields.custom.usp_list.value
        else
          assign usp_temp = ''
          for i in (1..5)
            assign usp_key = 'usp_' | append: i
            if product.metafields.custom[usp_key] != blank
              assign usp_temp = usp_temp | append: product.metafields.custom[usp_key] | append: '||'
            endif
          endfor
          assign usp_items = usp_temp | split: '||'
          if usp_items.size > 0 and usp_items.first != blank
            assign has_usp_list = true
          endif
        endif
      -%}

      {%- if has_usp_list -%}
        <ul class="usp-list">
          {%- for item in usp_items -%}
            {%- if item != blank -%}
              <li>
                <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
                  <circle cx="12" cy="12" r="11" fill="#e8e8e8"/>
                  <path d="M7 12.5l3.2 3L17 8.8" stroke="#5a5a5a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>{{ item | escape }}</span>
              </li>
            {%- endif -%}
          {%- endfor -%}
        </ul>
      {%- endif -%}

      <product-form class="product-form" data-section="{{ section_id }}">
        {%- liquid
          assign product_form_id = 'product-form-' | append: section_id
          assign selected_variant = product.selected_or_first_available_variant
        -%}
        
        {%- form 'product', product, id: product_form_id, novalidate: 'novalidate' -%}
          <input 
            type="hidden" 
            name="id" 
            value="{{ selected_variant.id }}" 
            id="VariantId-{{ section_id }}"
          >

          {%- comment -%}
          ============================================================
          COLOUR SWATCHES FROM SHOPIFY FILES (Tag-based)
          ============================================================
          {%- endcomment -%}
          {%- liquid
            assign product_tags = product.tags | join: ','
            assign has_product_tags = false
            
            if product_tags contains 'product_'
              assign has_product_tags = true
            endif
          -%}
          
          {%- if has_product_tags -%}
            <div class="product-option product-option--swatches">
              <ul class="ColorSwatchList">
                {%- assign current_product_url = product.url | split: '/' | last -%}
                
                {%- for i in (1..100) -%}
                  {%- for tag in product.tags -%}
                    {%- if tag contains 'product_' -%}
                      {%- assign tag_number = tag | split: '_' | first | plus: 0 -%}
                      
                      {%- if tag_number == i -%}
                        {%- assign product_tag = tag | split: '_' | last -%}
                        {%- assign color_display_name = product_tag | replace: '-', ' ' | capitalize -%}
                        {%- assign color_swatch_filename = 'tag_' | append: product_tag -%}
                        {%- assign swatch_file_url = 'https://cdn.shopify.com/s/files/1/0248/2497/1344/files/' | append: color_swatch_filename | append: '.jpg' -%}
                        {%- assign is_current = false -%}
                        
                        {%- if current_product_url == product_tag -%}
                          {%- assign is_current = true -%}
                        {%- endif -%}
                        
                        <li class="HorizontalList__Item{% if is_current %} current{% endif %}">
                          <a 
                            href="/products/{{ product_tag }}" 
                            class="ColorSwatchLink" 
                            title="{{ color_display_name }}"
                            {% if is_current %}aria-current="page"{% endif %}
                          >
                            <span 
                              class="ColorSwatch" 
                              style="background: url({{ swatch_file_url }});"
                            ></span>
                            <span class="ColorSwatch__Tooltip">{{ color_display_name }}</span>
                          </a>
                        </li>
                      {%- endif -%}
                    {%- endif -%}
                  {%- endfor -%}
                {%- endfor -%}
              </ul>
            </div>
          {%- endif -%}

          {%- comment -%}
          ============================================================
          VARIANT SELECTOR (Dropdown)
          ============================================================
          {%- endcomment -%}
          {%- if product.variants.size > 1 -%}
            <div class="product-option product-option--select">
              <label for="variant-select-{{ section_id }}">Select Option:</label>
              <select 
                id="variant-select-{{ section_id }}" 
                name="id" 
                class="variant-selector"
              >
                {%- for variant in product.variants -%}
                  <option 
                    value="{{ variant.id }}" 
                    {% if variant == selected_variant %}selected{% endif %} 
                    {% unless variant.available %}disabled{% endunless %}
                    data-price="{{ variant.price }}"
                    data-compare-price="{{ variant.compare_at_price }}"
                  >
                    {{ variant.title }} - {{ variant.price | money }}
                  </option>
                {%- endfor -%}
              </select>
            </div>
          {%- endif -%}

          <!-- Quantity + Add to Cart Row -->
          <div class="product-form__actions">
            <button
              type="submit"
              class="btn add-to-cart"
              {% unless selected_variant.available %}disabled{% endunless %}
              aria-live="polite"
            >
              {%- if selected_variant.available -%}
                Add to cart
              {%- else -%}
                Sold out
              {%- endif -%}
            </button>

            <div class="qty-wrapper">
              <span class="qty-label">Quantity</span>
              <div class="qty-control" data-qty>
                <button type="button" class="qty-btn" data-qty-dec aria-label="Decrease quantity">–</button>
                <input 
                  id="Quantity-{{ section_id }}" 
                  class="qty-input" 
                  type="number" 
                  name="quantity" 
                  value="1" 
                  min="1" 
                  step="1" 
                  inputmode="numeric" 
                  pattern="[0-9]*"
                  aria-label="Quantity"
                >
                <button type="button" class="qty-btn" data-qty-inc aria-label="Increase quantity">+</button>
              </div>
            </div>
          </div>

          {%- if section.settings.shipping_badge != blank -%}
            <div class="ship-badge">
              <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
                <circle cx="12" cy="12" r="11" fill="#e8f6ee"/>
                <path d="M7 12.5l3.2 3L17 8.8" stroke="#1ea66f" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <span>{{ section.settings.shipping_badge }}</span>
            </div>
          {%- endif -%}
        {%- endform -%}
      </product-form>

      <!-- Accordions -->
      <div class="product-accordions">
        {%- comment -%} First accordion - Product Details (always shown if enabled) {%- endcomment -%}
        {%- if section.settings.show_description -%}
          <details class="accordion"{% if section.settings.details_open %} open{% endif %}>
            <summary>{{ section.settings.description_heading }}</summary>
            <div class="accordion__content rte">
              {{ product.description }}
            </div>
          </details>
        {%- endif -%}
        
        {%- comment -%} Dynamic accordion blocks {%- endcomment -%}
        {%- for block in section.blocks -%}
          {%- case block.type -%}
            {%- when 'accordion_metafield' -%}
              {%- liquid
                assign metafield_value = blank
                assign metafield_namespace = block.settings.metafield_namespace
                assign metafield_key = block.settings.metafield_key
                
                if metafield_namespace != blank and metafield_key != blank
                  assign metafield_value = product.metafields[metafield_namespace][metafield_key]
                endif
                
                if metafield_value == blank and block.settings.fallback_content != blank
                  assign metafield_value = block.settings.fallback_content
                endif
              -%}
              
              {%- if metafield_value != blank -%}
                <details class="accordion" {{ block.shopify_attributes }}>
                  <summary>{{ block.settings.heading }}</summary>
                  <div class="accordion__content rte">
                    {{ metafield_value }}
                  </div>
                </details>
              {%- endif -%}
              
            {%- when 'accordion_custom' -%}
              {%- if block.settings.content != blank -%}
                <details class="accordion" {{ block.shopify_attributes }}>
                  <summary>{{ block.settings.heading }}</summary>
                  <div class="accordion__content rte">
                    {{ block.settings.content }}
                  </div>
                </details>
              {%- endif -%}
              
          {%- endcase -%}
        {%- endfor -%}
      </div>

      {%- if product.metafields.custom.product_details != blank -%}
        <div class="product-details-content">
          {{ product.metafields.custom.product_details }}
        </div>
      {%- endif -%}
    </div>
  </div>

  {%- comment -%} LIGHTBOX (popup viewer) {%- endcomment -%}
  <div class="pc-lightbox" id="PCLightbox-{{ section_id }}" hidden aria-hidden="true">
    <div class="pc-lightbox__overlay" data-close></div>
    <div class="pc-lightbox__content" role="dialog" aria-modal="true" aria-label="Product media" tabindex="-1">
      <button class="pc-lightbox__close" type="button" aria-label="Close" data-close>
        <svg width="22" height="22" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M6 6l12 12M18 6L6 18" stroke="white" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
      
      <button class="pc-lightbox__arrow pc-lightbox__arrow--prev" type="button" aria-label="Previous">
        <svg viewBox="0 0 24 24" width="22" height="22" aria-hidden="true">
          <path d="M15.5 4.5 8 12l7.5 7.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
      
      <div class="pc-lightbox__stage">
        {%- for media in product.media -%}
          <div 
            class="pc-lightbox__slide{% if forloop.first %} is-active{% endif %}{% if media.media_type == 'image' %} is-image{% endif %}" 
            data-media-id="{{ media.id }}"
          >
            {%- case media.media_type -%}
              {%- when 'image' -%}
                <img 
                  loading="lazy" 
                  decoding="async" 
                  src="{{ media | image_url: width: 2400 }}"
                  srcset="
                    {{ media | image_url: width: 1200 }} 1200w, 
                    {{ media | image_url: width: 1800 }} 1800w, 
                    {{ media | image_url: width: 2400 }} 2400w"
                  sizes="100vw"
                  alt="{{ media.alt | escape }}"
                  width="{{ media.preview_image.width }}"
                  height="{{ media.preview_image.height }}"
                >
              {%- when 'external_video' -%}
                {{ media | external_video_tag }}
              {%- when 'video' -%}
                {{ media | video_tag: controls: true, muted: false, loop: false, preload: 'metadata' }}
              {%- when 'model' -%}
                {{ media | model_viewer_tag }}
              {%- else -%}
                <img 
                  loading="lazy" 
                  decoding="async" 
                  src="{{ media | image_url: width: 2400 }}" 
                  alt="{{ media.alt | escape }}"
                >
            {%- endcase -%}
          </div>
        {%- endfor -%}
      </div>
      
      <button class="pc-lightbox__arrow pc-lightbox__arrow--next" type="button" aria-label="Next">
        <svg viewBox="0 0 24 24" width="22" height="22" aria-hidden="true">
          <path d="M8.5 4.5 16 12l-7.5 7.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
  </div>
</section>

<style>
  :root {
    --pc-accent: #3ABAB4;
    --pc-accent-hover: #2FA5A0;
    --pc-text-dark: #333333;
    --pc-text-light: #666666;
    --pc-text-muted: #999999;
    --pc-border: #E5E5E5;
    --pc-bg-light: #F8F8F8;
    --pc-sale: #E53935;
    --pc-thumbs-bg: #2D2D2D;
  }

  /* Base container */
  #product-custom-{{ section_id }} {
    background: #fff;
    --stick-top: 88px;
  }
  body.pc-no-scroll { overflow: hidden; }

  /* ============================================================
     LAYOUT
     ============================================================ */
  .product__container {
    display: grid;
    gap: 1.5rem;
    grid-template-columns: 1fr;
    max-width: 1400px;
    margin: 40px auto;
    padding: 0 16px;
  }

  @media (min-width: 990px) {
    .product__container {
      grid-template-columns: 1fr 1fr;
      align-items: start;
      gap: 3rem;
      padding: 0 40px;
      margin: 40px auto;
    }
  }

  /* ============================================================
     GALLERY - MOBILE (Swipe only, no thumbnails)
     ============================================================ */
  .product__media {
    position: relative;
  }

  /* ============================================================
     GALLERY - DESKTOP (Thumbnails with position options)
     ============================================================ */
  @media (min-width: 990px) {
    .product__media {
      position: sticky;
      top: var(--stick-top);
      align-self: start;
    }

    .product__media.has-thumbs {
      display: grid;
      gap: 12px;
    }

    /* Thumbnail LEFT */
    .product__media.thumbs-left {
      grid-template-columns: 80px 1fr;
      grid-template-areas: "thumbs main";
    }
    .product__media.thumbs-left .media-thumbs-desktop {
      grid-area: thumbs;
      flex-direction: column;
    }
    .product__media.thumbs-left .media-main {
      grid-area: main;
    }
    .product__media.thumbs-left .thumbs-scroll-desktop {
      flex-direction: column;
    }

    /* Thumbnail RIGHT */
    .product__media.thumbs-right {
      grid-template-columns: 1fr 80px;
      grid-template-areas: "main thumbs";
    }
    .product__media.thumbs-right .media-thumbs-desktop {
      grid-area: thumbs;
      flex-direction: column;
    }
    .product__media.thumbs-right .media-main {
      grid-area: main;
    }
    .product__media.thumbs-right .thumbs-scroll-desktop {
      flex-direction: column;
    }

    /* Thumbnail TOP */
    .product__media.thumbs-top {
      grid-template-columns: 1fr;
      grid-template-rows: auto 1fr;
      grid-template-areas: 
        "thumbs"
        "main";
    }
    .product__media.thumbs-top .media-thumbs-desktop {
      grid-area: thumbs;
      flex-direction: row;
    }
    .product__media.thumbs-top .media-main {
      grid-area: main;
    }
    .product__media.thumbs-top .thumbs-scroll-desktop {
      flex-direction: row;
    }

    /* Thumbnail BOTTOM */
    .product__media.thumbs-bottom {
      grid-template-columns: 1fr;
      grid-template-rows: 1fr auto;
      grid-template-areas: 
        "main"
        "thumbs";
    }
    .product__media.thumbs-bottom .media-thumbs-desktop {
      grid-area: thumbs;
      flex-direction: row;
    }
    .product__media.thumbs-bottom .media-main {
      grid-area: main;
    }
    .product__media.thumbs-bottom .thumbs-scroll-desktop {
      flex-direction: row;
    }
  }

  /* Desktop Thumbnails Container */
  .media-thumbs-desktop {
    display: none;
  }

  @media (min-width: 990px) {
    .media-thumbs-desktop {
      display: flex;
      background: var(--pc-thumbs-bg);
      border-radius: 8px;
      padding: 8px;
      gap: 8px;
      overflow: hidden;
      position: relative;
      align-items: center;
    }

    /* Vertical thumbnails (left/right) */
    .thumbs-left .media-thumbs-desktop,
    .thumbs-right .media-thumbs-desktop {
      max-height: calc(100vh - var(--stick-top) - 40px);
    }

    /* Horizontal thumbnails (top/bottom) */
    .thumbs-top .media-thumbs-desktop,
    .thumbs-bottom .media-thumbs-desktop {
      max-width: 100%;
    }

    .thumbs-scroll-desktop {
      display: flex;
      gap: 8px;
      overflow: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .thumbs-scroll-desktop::-webkit-scrollbar {
      display: none;
    }

    /* Vertical scroll */
    .thumbs-left .thumbs-scroll-desktop,
    .thumbs-right .thumbs-scroll-desktop {
      overflow-y: auto;
      overflow-x: hidden;
    }

    /* Horizontal scroll */
    .thumbs-top .thumbs-scroll-desktop,
    .thumbs-bottom .thumbs-scroll-desktop {
      overflow-x: auto;
      overflow-y: hidden;
    }

    .thumb-desktop {
      flex-shrink: 0;
      width: 64px;
      height: 64px;
      border-radius: 6px;
      overflow: hidden;
      cursor: pointer;
      border: 2px solid transparent;
      background: #fff;
      padding: 0;
      transition: border-color 0.2s ease, transform 0.2s ease;
    }

    .thumb-desktop img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .thumb-desktop.is-active {
      border-color: var(--pc-accent);
    }

    .thumb-desktop:hover:not(.is-active) {
      transform: scale(1.05);
    }

    .thumbs-arrow-desktop {
      flex-shrink: 0;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: rgba(255,255,255,0.9);
      border: none;
      cursor: pointer;
      display: grid;
      place-items: center;
      z-index: 2;
      padding: 0;
      transition: background 0.2s;
    }

    .thumbs-arrow-desktop:hover {
      background: #fff;
    }

    .thumbs-arrow-desktop[hidden] {
      display: none !important;
    }
  }

  /* Main Image Stage */
  .media-main {
    position: relative;
  }

  .media-stage {
    position: relative;
    width: 100%;
    aspect-ratio: var(--pc-aspect, 1);
    background: #fff;
    overflow: hidden;
    touch-action: pan-y pinch-zoom;
    border-radius: 8px;
    cursor: grab;
  }

  .media-stage:active {
    cursor: grabbing;
  }

  .media-slide {
    position: absolute;
    inset: 0;
    display: none;
  }

  .media-slide.is-active {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .media-slide img,
  .media-slide video,
  .media-slide model-viewer {
    width: 100%;
    height: 100%;
    object-fit: contain;
    background: #fff;
    display: block;
    user-select: none;
    pointer-events: none;
  }

  @media (max-width: 989px) {
    .media-stage {
      max-height: 68vh;
      min-height: 300px;
      border-radius: 0;
    }
  }

  @media (min-width: 990px) {
    .media-stage {
      max-height: calc(100vh - var(--stick-top) - 140px);
      min-height: 420px;
    }
  }

  /* Navigation Arrows (Desktop only) */
  .pc-arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: #fff;
    color: #111;
    border: 1px solid rgba(0,0,0,0.15);
    width: 44px;
    height: 44px;
    border-radius: 50%;
    display: none;
    place-items: center;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    z-index: 6;
    padding: 0;
    transition: background 0.2s, color 0.2s;
  }

  .pc-arrow--prev { left: 12px; }
  .pc-arrow--next { right: 12px; }

  .pc-arrow:hover {
    background: var(--pc-accent);
    color: #fff;
    border-color: var(--pc-accent);
  }

  @media (min-width: 990px) {
    .pc-arrow {
      display: grid;
    }
  }

  /* Dots (Mobile only) */
  .media-dots {
    display: flex;
    gap: 6px;
    justify-content: center;
    padding: 12px 0;
  }

  .media-dots .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #D9D9D9;
    border: 0;
    cursor: pointer;
    padding: 0;
    transition: background 0.2s;
  }

  .media-dots .dot.is-active {
    background: var(--pc-accent);
  }

  @media (min-width: 990px) {
    .media-dots {
      display: none;
    }
  }

  /* ============================================================
     PRODUCT INFO
     ============================================================ */
  .product__info {
    background: #fff;
    padding: 0;
  }

  @media (max-width: 989px) {
    .product__info {
      padding: 0 4px;
    }
  }

  /* Title */
  .product__title {
    margin: 0 0 8px 0;
    font-size: 1.5rem;
    font-weight: 700;
    line-height: 1.2;
    color: var(--pc-text-dark);
  }

  @media (min-width: 990px) {
    .product__title {
      font-size: 2rem;
    }
  }

  /* Price Block */
  .product__price {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
  }

  /* Regular Price - Always visible */
  .price__regular {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--pc-text-dark);
    display: inline-block;
  }

  /* Regular Price when on sale - can add color if needed */
  .price__regular--sale {
    color: var(--pc-text-dark);
  }

  /* Compare/Original Price - Only shows when on sale (strikethrough) */
  .price__compare {
    font-size: 1rem;
    color: var(--pc-text-muted);
    text-decoration: line-through;
    display: inline-block;
  }

  @media (min-width: 990px) {
    .price__regular {
      font-size: 1.5rem;
    }
    .price__compare {
      font-size: 1.125rem;
    }
  }

  /* Judge.me Reviews */
  .jdgm-widget {
    margin-bottom: 12px;
  }

  /* Product Description */
  .product__description {
    font-size: 0.9375rem;
    line-height: 1.6;
    color: var(--pc-text-light);
    margin-bottom: 8px;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .product__description.expanded {
    -webkit-line-clamp: unset;
    display: block;
  }

  .see-more-link {
    display: inline-block;
    font-size: 0.875rem;
    color: var(--pc-accent);
    text-decoration: none;
    margin-bottom: 16px;
    cursor: pointer;
  }

  .see-more-link:hover {
    text-decoration: underline;
  }

  /* USP List */
  .usp-list {
    margin: 0 0 1rem;
    padding: 0;
    list-style: none;
    display: grid;
    gap: 6px;
  }

  .usp-list li {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--pc-text-light);
    font-size: 0.9rem;
    margin: 0;
  }

  /* ============================================================
     COLOR SWATCHES
     ============================================================ */
  .product-option--swatches {
    margin: 1rem 0;
  }

  .ColorSwatchList {
    display: flex;
    gap: 10px;
    list-style: none;
    padding: 0;
    margin: 0;
    flex-wrap: wrap;
  }

  .ColorSwatchLink {
    position: relative;
    display: inline-block;
    text-decoration: none;
  }

  .ColorSwatch {
    display: block;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: 2px solid #E5E5E5;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    cursor: pointer;
    transition: transform 0.2s ease, border-color 0.2s ease;
  }

  .ColorSwatchLink:hover .ColorSwatch {
    transform: scale(1.1);
    border-color: var(--pc-accent);
  }

  .HorizontalList__Item.current .ColorSwatch {
    border-color: var(--pc-accent);
    box-shadow: 0 0 0 2px rgba(58, 186, 180, 0.3);
  }

  .ColorSwatch__Tooltip {
    position: absolute;
    bottom: -28px;
    left: 50%;
    transform: translateX(-50%);
    background: #111;
    color: #fff;
    font-size: 11px;
    padding: 4px 8px;
    border-radius: 4px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
    z-index: 10;
  }

  .ColorSwatchLink:hover .ColorSwatch__Tooltip {
    opacity: 1;
  }

  /* Variant Selector */
  .product-option--select {
    margin: 1rem 0;
  }

  .product-option--select label {
    font-weight: 600;
    font-size: 0.875rem;
    margin-bottom: 6px;
    display: block;
    color: var(--pc-text-dark);
  }

  .variant-selector {
    width: 100%;
    padding: 12px 14px;
    border: 1px solid var(--pc-border);
    border-radius: 8px;
    font: inherit;
    font-size: 0.9375rem;
    background: #fff;
    cursor: pointer;
    color: var(--pc-text-dark);
  }

  .variant-selector:focus {
    outline: none;
    border-color: var(--pc-accent);
    box-shadow: 0 0 0 3px rgba(58, 186, 180, 0.15);
  }

  /* ============================================================
     FORM ACTIONS: Add to Cart + Quantity
     ============================================================ */
  .product-form {
    margin: 1rem 0;
  }

  .product-form__actions {
    display: flex;
    gap: 12px;
    align-items: flex-end;
    flex-wrap: wrap;
  }

  @media (max-width: 989px) {
    .product-form__actions {
      flex-direction: column;
      align-items: stretch;
    }

    .qty-wrapper {
      order: -1;
    }
  }

  /* Add to Cart Button */
  .btn.add-to-cart {
    display: inline-flex;
    justify-content: center;
    align-items: center;
    padding: 14px 32px;
    border: 0;
    border-radius: 8px;
    background: var(--pc-accent);
    color: #fff;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
    flex: 1;
    min-width: 160px;
  }

  .btn.add-to-cart:hover {
    background: var(--pc-accent-hover);
  }

  .btn.add-to-cart:disabled {
    background: #ccc;
    cursor: not-allowed;
  }

  .btn.add-to-cart:focus-visible {
    outline: 2px solid var(--pc-accent);
    outline-offset: 2px;
  }

  @media (max-width: 989px) {
    .btn.add-to-cart {
      width: 100%;
      padding: 16px 24px;
    }
  }

  /* Quantity Wrapper */
  .qty-wrapper {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .qty-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--pc-text-dark);
  }

  .qty-control {
    display: flex;
    align-items: center;
    border: 1px solid var(--pc-border);
    border-radius: 8px;
    overflow: hidden;
    background: #fff;
    height: 48px;
  }

  .qty-btn {
    width: 44px;
    height: 100%;
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: 1.25rem;
    color: var(--pc-text-dark);
    display: grid;
    place-items: center;
    transition: background 0.2s;
    padding: 0;
  }

  .qty-btn:hover {
    background: var(--pc-bg-light);
  }

  .qty-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  .qty-input {
    width: 48px;
    height: 100%;
    border: none;
    text-align: center;
    font: inherit;
    font-weight: 600;
    font-size: 1rem;
    color: var(--pc-text-dark);
    -moz-appearance: textfield;
  }

  .qty-input::-webkit-outer-spin-button,
  .qty-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  .qty-input:focus {
    outline: none;
  }

  @media (max-width: 989px) {
    .qty-control {
      width: 100%;
      justify-content: space-between;
    }

    .qty-btn {
      width: 56px;
    }

    .qty-input {
      flex: 1;
    }
  }

  /* Shipping Badge */
  .ship-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #1ea66f;
    font-weight: 500;
    font-size: 0.875rem;
    margin-top: 12px;
  }

  /* ============================================================
     ACCORDIONS
     ============================================================ */
  .product-accordions {
    border-top: 1px solid var(--pc-border);
    margin-top: 1.5rem;
  }

  .accordion {
    border-bottom: 1px solid var(--pc-border);
  }

  .accordion summary {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    padding: 16px 0;
    font-weight: 600;
    font-size: 0.9375rem;
    color: var(--pc-text-dark);
    list-style: none;
    position: relative;
    padding-right: 28px;
  }

  .accordion summary::-webkit-details-marker {
    display: none;
  }

  .accordion summary::after {
    content: '+';
    position: absolute;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    font-weight: 300;
    font-size: 1.5rem;
    line-height: 1;
    color: var(--pc-text-muted);
    transition: transform 0.2s;
  }

  .accordion[open] summary::after {
    content: '–';
  }

  .accordion summary:hover {
    color: var(--pc-accent);
  }

  .accordion summary:hover::after {
    color: var(--pc-accent);
  }

  .accordion[open] summary {
    border-bottom: none;
  }

  .accordion__content {
    padding: 0 0 16px;
    color: var(--pc-text-light);
    font-size: 0.9375rem;
    line-height: 1.6;
  }

  /* Product details content */
  .product-details-content {
    margin: 1rem 0;
    padding: 1rem 0;
    color: var(--pc-text-light);
    font-size: 0.9375rem;
    line-height: 1.6;
  }

  .product-details-content p {
    margin: 0 0 0.75rem;
  }

  .product-details-content p:last-child {
    margin-bottom: 0;
  }

  /* ============================================================
     LIGHTBOX
     ============================================================ */
  .pc-lightbox {
    position: fixed;
    inset: 0;
    z-index: 2147483000;
  }

  .pc-lightbox[hidden] {
    display: none;
  }

  .pc-lightbox__overlay {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.85);
    -webkit-backdrop-filter: blur(4px);
    backdrop-filter: blur(4px);
  }

  .pc-lightbox__content {
    position: relative;
    inset: 0;
    width: 100%;
    height: 100%;
  }

  .pc-lightbox__stage {
    position: absolute;
    top: clamp(10px, 8vh, 96px);
    bottom: clamp(10px, 8vh, 96px);
    left: clamp(10px, 5vw, 96px);
    right: clamp(10px, 5vw, 96px);
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
    padding-left: env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .pc-lightbox__slide {
    position: absolute;
    display: none;
  }

  .pc-lightbox__slide.is-active {
    display: block;
  }

  .pc-lightbox__slide img,
  .pc-lightbox__slide video,
  .pc-lightbox__slide model-viewer {
    max-width: min(92vw, 1200px);
    max-height: min(82vh, 1200px);
    width: auto;
    height: auto;
    object-fit: contain;
    background: #111;
    border-radius: 8px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    display: block;
    margin: 0 auto;
  }

  @media (max-width: 740px) {
    .pc-lightbox__slide img,
    .pc-lightbox__slide video,
    .pc-lightbox__slide model-viewer {
      max-width: 94vw;
      max-height: 70vh;
    }
  }

  .pc-lightbox__arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: #fff;
    color: #111;
    border: none;
    box-shadow: 0 4px 16px rgba(0,0,0,0.2);
    display: grid;
    place-items: center;
    cursor: pointer;
    z-index: 3;
    transition: transform 0.15s ease, box-shadow 0.15s ease;
    padding: 0;
  }

  .pc-lightbox__arrow:hover {
    transform: translateY(-50%) scale(1.05);
    box-shadow: 0 6px 24px rgba(0,0,0,0.3);
  }

  .pc-lightbox__arrow--prev {
    left: clamp(12px, 3vw, 24px);
  }

  .pc-lightbox__arrow--next {
    right: clamp(12px, 3vw, 24px);
  }

  @media (max-width: 740px) {
    .pc-lightbox__arrow {
      width: 40px;
      height: 40px;
    }
  }

  .pc-lightbox__close {
    position: absolute;
    top: calc(env(safe-area-inset-top) + 12px);
    right: calc(env(safe-area-inset-right) + 12px);
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: rgba(0,0,0,0.6);
    border: 1px solid rgba(255,255,255,0.3);
    color: #fff;
    display: grid;
    place-items: center;
    z-index: 4;
    box-shadow: 0 4px 16px rgba(0,0,0,0.3);
    padding: 0;
    cursor: pointer;
    transition: background 0.2s;
  }

  .pc-lightbox__close:hover {
    background: rgba(0,0,0,0.8);
  }

  /* ============================================================
     BOTTOM PADDING
     ============================================================ */
  #product-custom-{{ section_id }} {
    padding-bottom: 48px;
  }

  @media (min-width: 990px) {
    #product-custom-{{ section_id }} {
      padding-bottom: 96px;
    }
  }
</style>

<script>
  (function(){
    function boot(){
      const productData = {{ product | json }};
      const section = document.getElementById('product-custom-{{ section_id }}');
      const stage = document.querySelector('#MediaMain-{{ section_id }} .media-stage');
      if (!stage) return;

      const slides = Array.from(stage.querySelectorAll('.media-slide'));
      const dotsWrap = document.getElementById('MediaDots-{{ section_id }}');
      const dots = dotsWrap ? Array.from(dotsWrap.querySelectorAll('.dot')) : [];

      const prevBtn = stage.querySelector('.pc-arrow--prev');
      const nextBtn = stage.querySelector('.pc-arrow--next');

      const priceEl = document.getElementById('price-{{ section_id }}');

      // Desktop thumbs
      const thumbsDesktop = document.getElementById('MediaThumbsDesktop-{{ section_id }}');
      const thumbsD = thumbsDesktop ? Array.from(thumbsDesktop.querySelectorAll('.thumb-desktop')) : [];
      const thumbsScrollD = thumbsDesktop?.querySelector('.thumbs-scroll-desktop');

      let current = Math.max(0, slides.findIndex(s => s.classList.contains('is-active')));
      const clamp = (i) => (i + slides.length) % slides.length;

      function setActiveIndex(i){
        if (!slides.length) return;
        i = clamp(i);
        slides.forEach((el, idx) => el.classList.toggle('is-active', idx === i));
        
        // Update desktop thumbs
        thumbsD.forEach((el, idx) => {
          const on = idx === i;
          el.classList.toggle('is-active', on);
          el.toggleAttribute('aria-current', on);
        });
        
        dots.forEach((el, idx) => {
          const on = idx === i;
          el.classList.toggle('is-active', on);
          el.toggleAttribute('aria-current', on);
        });
        current = i;
        
        // Scroll desktop thumb into view
        const tD = thumbsD[i];
        if (tD && tD.scrollIntoView && thumbsScrollD){
          const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
          tD.scrollIntoView({ behavior: prefersReduced ? 'auto' : 'smooth', block: 'nearest', inline: 'nearest' });
        }
        
        bindZoomHandlers();
      }
      
      function setActiveByMediaId(id){
        const idx = slides.findIndex(s => s.getAttribute('data-media-id') === String(id));
        if (idx >= 0) setActiveIndex(idx);
      }

      // Desktop thumbs click handler
      thumbsDesktop?.addEventListener('click', (e) => {
        const btn = e.target.closest('.thumb-desktop'); if (!btn) return;
        setActiveIndex(Number(btn.getAttribute('data-target-index') || '0'));
      });
      
      dotsWrap?.addEventListener('click', (e) => {
        const btn = e.target.closest('.dot'); if (!btn) return;
        setActiveIndex(Number(btn.getAttribute('data-target-index') || '0'));
      });

      prevBtn?.addEventListener('click', () => setActiveIndex(current - 1));
      nextBtn?.addEventListener('click', () => setActiveIndex(current + 1));

      stage.setAttribute('tabindex', '0');
      stage.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') { e.preventDefault(); setActiveIndex(current - 1); }
        if (e.key === 'ArrowRight') { e.preventDefault(); setActiveIndex(current + 1); }
        if (e.key === 'Enter') { e.preventDefault(); lbOpen(current); }
      });
      
      // Mobile swipe functionality
      let touchStartX = null;
      let touchStartY = null;
      let touchCurrentX = null;
      let isSwiping = false;
      const swipeThreshold = 50;
      
      stage.addEventListener('touchstart', (e) => {
        const touch = e.touches[0];
        touchStartX = touch.clientX;
        touchStartY = touch.clientY;
        touchCurrentX = touchStartX;
        isSwiping = false;
      }, { passive: true });
      
      stage.addEventListener('touchmove', (e) => {
        if (touchStartX === null) return;
        const touch = e.touches[0];
        touchCurrentX = touch.clientX;
        const dx = touchCurrentX - touchStartX;
        const dy = touch.clientY - touchStartY;
        
        // If horizontal movement is greater than vertical, it's a swipe
        if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 10) {
          isSwiping = true;
        }
      }, { passive: true });
      
      stage.addEventListener('touchend', (e) => {
        if (touchStartX === null || !isSwiping) {
          touchStartX = null;
          touchStartY = null;
          return;
        }
        
        const dx = touchCurrentX - touchStartX;
        
        if (Math.abs(dx) > swipeThreshold) {
          if (dx < 0) {
            // Swipe left - next image
            setActiveIndex(current + 1);
          } else {
            // Swipe right - previous image
            setActiveIndex(current - 1);
          }
        }
        
        touchStartX = null;
        touchStartY = null;
        touchCurrentX = null;
        isSwiping = false;
      });

      // Click to open lightbox (desktop)
      stage.addEventListener('click', (e) => {
        if (e.target.closest('.pc-arrow')) return;
        if (window.innerWidth < 990) return; // Don't open lightbox on mobile tap
        const active = slides[current];
        if (active && active.classList.contains('is-image')) lbOpen(current);
      });

      function money(cents){
        return (typeof Shopify!=='undefined' && Shopify.formatMoney)
          ? Shopify.formatMoney(cents, '{{ shop.money_format | strip_newlines }}')
          : '{{ cart.currency.symbol | default: "$" }}' + (cents/100).toFixed(2);
      }

      function renderPrice(v){
        if (!priceEl) return;
        let html = '';
        if (v.compare_at_price && v.compare_at_price > v.price){
          // On Sale: Show compare price (strikethrough) + current price
          html = '<span class="price__compare">' + money(v.compare_at_price) + '</span>';
          html += '<span class="price__regular price__regular--sale">' + money(v.price) + '</span>';
        } else {
          // Not on Sale: Show regular price only
          html = '<span class="price__regular">' + money(v.price) + '</span>';
        }
        priceEl.innerHTML = html;
      }

      const finePointer = window.matchMedia && window.matchMedia('(pointer: fine)').matches;
      let unbindZoom = function(){};
      function bindZoomHandlers(){
        unbindZoom();
        stage.classList.remove('is-zooming');

        const active = slides[current];
        if (!active || !active.classList.contains('is-image')) { return; }
        const img = active.querySelector('.zoom-target'); if (!img) return;

        let onEnter, onLeave, onMove;
        if (finePointer){
          onEnter = () => stage.classList.add('is-zooming');
          onLeave = () => stage.classList.remove('is-zooming');
          onMove = (e) => {
            const rect = img.getBoundingClientRect();
            const x = ((e.clientX - rect.left)/rect.width)*100;
            const y = ((e.clientY - rect.top)/rect.height)*100;
            stage.style.setProperty('--zoom-x', x+'%');
            stage.style.setProperty('--zoom-y', y+'%');
            stage.style.setProperty('--zoom-scale', 1.8);
          };
          img.addEventListener('mouseenter', onEnter);
          img.addEventListener('mouseleave', onLeave);
          img.addEventListener('mousemove', onMove);

          unbindZoom = () => {
            img.removeEventListener('mouseenter', onEnter);
            img.removeEventListener('mouseleave', onLeave);
            img.removeEventListener('mousemove', onMove);
          };
        }
      }

      // ===== VARIANT DROPDOWN CHANGE HANDLER =====
      const variantSelect = document.querySelector('#variant-select-{{ section_id }}');
      if (variantSelect){
        variantSelect.addEventListener('change', (e) => {
          const variantId = Number(e.target.value);
          const variant = productData.variants.find(v => v.id === variantId);
          if (!variant) return;
          
          const idEl = document.getElementById('VariantId-{{ section_id }}'); 
          if (idEl) idEl.value = variant.id;
          
          renderPrice(variant);
          
          if (variant.featured_media && variant.featured_media.id) {
            setActiveByMediaId(variant.featured_media.id);
          }
          
          const btn = document.querySelector('#product-custom-{{ section_id }} .add-to-cart');
          if (btn){ 
            btn.disabled = !variant.available; 
            btn.textContent = variant.available ? 'Add to cart' : 'Sold out'; 
          }
          
          if (typeof URL === 'function' && history && history.replaceState){
            const u = new URL(location.href); 
            u.searchParams.set('variant', variant.id); 
            history.replaceState(null,'',u.toString());
          }
        });
      }

      // Quantity stepper
      const qtyWrap = document.querySelector('#product-custom-{{ section_id }} [data-qty]');
      if (qtyWrap){
        const input = qtyWrap.querySelector('.qty-input');
        const dec = qtyWrap.querySelector('[data-qty-dec]');
        const inc = qtyWrap.querySelector('[data-qty-inc]');
        const step = parseInt(input.getAttribute('step') || '1', 10);
        const min  = parseInt(input.getAttribute('min')  || '1', 10);

        const clampQty = v => Math.max(min, isNaN(v) ? min : v);
        const setVal = v => {
          const n = clampQty(v);
          if (n !== Number(input.value)){
            input.value = n;
            input.dispatchEvent(new Event('input',  { bubbles:true }));
            input.dispatchEvent(new Event('change', { bubbles:true }));
          }
          dec.disabled = Number(input.value) <= min;
        };

        dec.addEventListener('click', ()=> setVal(Number(input.value || min) - step));
        inc.addEventListener('click', ()=> setVal(Number(input.value || min) + step));
        input.addEventListener('blur', ()=> setVal(Number(input.value)));
        dec.disabled = Number(input.value) <= min;
      }

      // See more link toggle
      const seeMoreLink = document.getElementById('see-more-{{ section_id }}');
      const descriptionEl = document.querySelector('#product-custom-{{ section_id }} .product__description');
      if (seeMoreLink && descriptionEl) {
        seeMoreLink.addEventListener('click', (e) => {
          e.preventDefault();
          descriptionEl.classList.toggle('expanded');
          seeMoreLink.textContent = descriptionEl.classList.contains('expanded') ? 'See Less' : 'See More';
        });
      }

      // Initialize price
      try{
        const initial = productData.variants.find(v => v.id === {{ product.selected_or_first_available_variant.id }});
        if (initial){ 
          renderPrice(initial); 
          if (initial.featured_media) setActiveByMediaId(initial.featured_media.id); 
        } else if (productData.variants && productData.variants[0]) { 
          renderPrice(productData.variants[0]); 
        }
      }catch(e){ console.error('Price init error:', e); }
      bindZoomHandlers();

      /* ===== LIGHTBOX ===== */
      const lb = document.getElementById('PCLightbox-{{ section_id }}');
      const lbSlides = Array.from(lb.querySelectorAll('.pc-lightbox__slide'));
      const lbPrev = lb.querySelector('.pc-lightbox__arrow--prev');
      const lbNext = lb.querySelector('.pc-lightbox__arrow--next');
      const lbClose = lb.querySelector('.pc-lightbox__close');
      const lbOverlay = lb.querySelector('[data-close]');

      let lbIndex = 0;
      const lbClamp = (i)=> (i + lbSlides.length) % lbSlides.length;

      function lbSet(i){
        if (!lbSlides.length) return;
        i = lbClamp(i);
        lbSlides.forEach((el, idx)=> {
          el.classList.toggle('is-active', idx === i);
          el.querySelectorAll('video').forEach(v=>v.pause());
        });
        lbIndex = i;
      }
      function lbOpen(start){
        document.body.classList.add('pc-no-scroll');
        lb.hidden = false;
        lb.setAttribute('aria-hidden', 'false');
        lbSet(typeof start==='number' ? start : current);
        lb.querySelector('.pc-lightbox__content').focus();
        document.addEventListener('keydown', onLbKey);
      }
      function lbCloseFn(){
        lb.hidden = true;
        lb.setAttribute('aria-hidden', 'true');
        document.body.classList.remove('pc-no-scroll');
        document.removeEventListener('keydown', onLbKey);
      }
      function onLbKey(e){
        if (e.key === 'Escape') lbCloseFn();
        if (e.key === 'ArrowLeft') lbSet(lbIndex - 1);
        if (e.key === 'ArrowRight') lbSet(lbIndex + 1);
      }

      lbPrev.addEventListener('click', ()=> lbSet(lbIndex - 1));
      lbNext.addEventListener('click', ()=> lbSet(lbIndex + 1));
      lbClose.addEventListener('click', lbCloseFn);
      lbOverlay.addEventListener('click', lbCloseFn);

      // Lightbox swipe
      let lbTouchX=null, lbTouchY=null;
      lb.addEventListener('touchstart', (e)=>{ const t=e.changedTouches[0]; lbTouchX=t.clientX; lbTouchY=t.clientY; }, {passive:true});
      lb.addEventListener('touchend', (e)=>{
        if (lbTouchX==null) return;
        const t=e.changedTouches[0], dx=t.clientX-lbTouchX, dy=t.clientY-lbTouchY;
        if (Math.abs(dx)>30 && Math.abs(dx)>Math.abs(dy)) lbSet(lbIndex + (dx<0?1:-1));
        lbTouchX=lbTouchY=null;
      });

      window.lbOpen = lbOpen;
    }

    if (document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', boot, { once:true });
    } else {
      boot();
    }
  })();
</script>

{% schema %}
{
  "name": "Product Custom",
  "tag": "section",
  "class": "section-product-custom",
  "settings": [
    {
      "type": "header",
      "content": "Gallery Thumbnails"
    },
    {
      "type": "checkbox",
      "id": "show_thumbnails",
      "label": "Show thumbnails (Desktop only)",
      "default": true,
      "info": "Enable or disable thumbnail navigation on desktop. Mobile always uses swipe."
    },
    {
      "type": "select",
      "id": "thumbnail_position",
      "label": "Thumbnail position",
      "options": [
        {
          "value": "left",
          "label": "Left"
        },
        {
          "value": "right",
          "label": "Right"
        },
        {
          "value": "top",
          "label": "Top"
        },
        {
          "value": "bottom",
          "label": "Bottom"
        }
      ],
      "default": "left",
      "info": "Position of thumbnails relative to main image (Desktop only)"
    },
    {
      "type": "header",
      "content": "Product Description Accordion"
    },
    {
      "type": "checkbox",
      "id": "show_description",
      "label": "Show product description accordion",
      "default": true,
      "info": "Displays the product description in an accordion"
    },
    {
      "type": "text",
      "id": "description_heading",
      "label": "Description heading",
      "default": "Product Details",
      "info": "Customize the accordion heading text"
    },
    {
      "type": "checkbox",
      "id": "details_open",
      "label": "Open description accordion by default",
      "default": true
    },
    {
      "type": "header",
      "content": "Shipping Badge"
    },
    {
      "type": "text",
      "id": "shipping_badge",
      "label": "Shipping badge text",
      "info": "Text displayed below the Add to Cart button",
      "default": "Free shipping on orders over $50"
    },
    {
      "type": "paragraph",
      "content": "Use the blocks below to add custom accordion sections. You can pull content from product metafields or add custom HTML content."
    }
  ],
  "blocks": [
    {
      "type": "accordion_metafield",
      "name": "Accordion (Metafield)",
      "settings": [
        {
          "type": "text",
          "id": "heading",
          "label": "Heading",
          "default": "Additional Information",
          "info": "The accordion section title"
        },
        {
          "type": "text",
          "id": "metafield_namespace",
          "label": "Metafield namespace",
          "info": "Enter the namespace (e.g., 'custom')",
          "default": "custom"
        },
        {
          "type": "text",
          "id": "metafield_key",
          "label": "Metafield key",
          "info": "Enter the key (e.g., 'dimensions', 'specifications', 'shipping')",
          "placeholder": "dimensions"
        },
        {
          "type": "textarea",
          "id": "fallback_content",
          "label": "Fallback content (plain text)",
          "info": "Plain text content to show if metafield is empty. For HTML, leave empty and set content in the metafield."
        }
      ]
    },
    {
      "type": "accordion_custom",
      "name": "Accordion",
      "settings": [
        {
          "type": "text",
          "id": "heading",
          "label": "Heading",
          "default": "Custom Information",
          "info": "The accordion section title"
        },
        {
          "type": "richtext",
          "id": "content",
          "label": "Content",
          "info": "Rich text content for this accordion section"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Product Custom",
      "blocks": [
        {
          "type": "accordion_metafield",
          "settings": {
            "heading": "Product Dimensions",
            "metafield_namespace": "custom",
            "metafield_key": "dimensions"
          }
        },
        {
          "type": "accordion_metafield",
          "settings": {
            "heading": "Product Specifications",
            "metafield_namespace": "custom",
            "metafield_key": "specifications"
          }
        },
        {
          "type": "accordion_metafield",
          "settings": {
            "heading": "Shipping & Delivery",
            "metafield_namespace": "custom",
            "metafield_key": "shipping"
          }
        }
      ]
    }
  ]
}
{% endschema %}
