{% stylesheet %}
.bestseller-section {
  background: #f9f9f9;
  margin: 0 auto;
}

.bestseller-wrapper {
  max-width: var(--section-width, 1400px);
  padding: var(--section-padding, 60px 2rem);
  margin: 0 auto;
}

/* Header layout - MOBILE FIX */
.bestseller-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 1rem;
  margin-bottom: 2rem;
}

.bestseller-heading {
  font-size: 2rem;
  font-weight: 600;
  flex: 1;
  text-align: left;
  min-width: 200px;
}

.bestseller-tabs {
  display: flex;
  justify-content: center;
  gap: 1rem;
  flex: 2;
  flex-wrap: wrap;
}

.bestseller-tab {
  cursor: pointer;
  color: #777;
  position: relative;
  transition: color 0.2s ease;
  white-space: nowrap;
}

.bestseller-tab:hover {
  color: #20c6b1;
}

.bestseller-tab.active {
  color: #20c6b1;
}

.bestseller-tab.active::after {
  content: '';
  position: absolute;
  bottom: -6px;
  left: 0;
  right: 0;
  height: 2px;
  background: #20c6b1;
  margin: 0 auto;
  width: 100%;
}

/* Arrows */
.bestseller-arrows {
  display: flex;
  justify-content: flex-end;
  gap: 0.5rem;
  flex: 1;
  min-width: 80px;
}

.bestseller-arrow {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 1.1rem;
  color: #999;
  transition: color 0.2s ease;
  padding: 0.5rem;
}

.bestseller-arrow:hover {
  color: #20c6b1;
}

/* Slider area - CRITICAL MOBILE FIXES */
.bestseller-slider-container {
  position: relative;
  overflow: hidden;
  width: 100%;
}

.bestseller-slider {
  display: flex;
  gap: var(--card-gap, 1.5rem);
  transition: transform 0.4s ease;
  width: 100%;
}

.bestseller-card {
  background: #fff;
  border-radius: 12px;
  overflow: hidden;
  position: relative;
  transition: transform 0.3s ease;
  flex-shrink: 0;
  box-sizing: border-box;
}

.bestseller-card:hover {
  transform: translateY(-4px);
}

.bestseller-card img {
  width: 100%;
  height: auto;
  object-fit: cover;
  display: block;
}

.bestseller-label {
  position: absolute;
  top: 10px;
  right: 10px;
  background: #fff;
  border-radius: 4px;
  padding: 4px 8px;
  font-size: 0.8rem;
  font-weight: 600;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.hidden {
  display: none !important;
}

/* Disabled state for arrows */
.bestseller-arrow.disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

.bestseller-arrow.disabled:hover {
  color: #999;
}

/* MOBILE RESPONSIVE STYLES */
@media (max-width: 768px) {
  .bestseller-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 1.5rem;
  }
  
  .bestseller-heading {
    text-align: center;
    width: 100%;
    font-size: 1.5rem;
  }
  
  .bestseller-tabs {
    justify-content: center;
    width: 100%;
    order: 2;
    gap: 0.5rem;
  }
  
  .bestseller-tab {
    font-size: 0.8rem;
    padding: 0.5rem 0.75rem;
  }
  
  .bestseller-arrows {
    justify-content: center;
    width: 100%;
    order: 3;
    margin-top: 1rem;
  }
  
  .bestseller-wrapper {
    padding: var(--section-padding, 40px 1rem);
  }
  
  .bestseller-slider {
    gap: calc(var(--card-gap, 1.5rem) * 0.75);
  }
}

@media (max-width: 480px) {
  .bestseller-tabs {
    flex-wrap: nowrap;
    overflow-x: auto;
    justify-content: center;
    padding-bottom: 0.5rem;
    scrollbar-width: none;
    -ms-overflow-style: none;
  }
  
  .bestseller-tabs::-webkit-scrollbar {
    display: none;
  }
  
  .bestseller-tab {
    flex-shrink: 0;
  }
}
{% endstylesheet %}

<section
  class="bestseller-section"
  data-section-id="{{ section.id }}"
  data-desktop-columns="{{ section.settings.desktop_columns }}"
  data-mobile-columns="{{ section.settings.mobile_columns }}"
  data-card-gap="{{ section.settings.card_gap }}"
  style="
    --section-width: {{ section.settings.max_width }}px;
    --section-padding: {{ section.settings.section_padding }}px 2rem;
    --card-gap: {{ section.settings.card_gap }}px;
  "
>
  <div class="bestseller-wrapper">
    <div class="bestseller-header">
      <h2 class="bestseller-heading">{{ section.settings.heading }}</h2>

      <div class="bestseller-tabs">
        {% for block in section.blocks %}
          <div class="bestseller-tab{% if forloop.first %} active{% endif %}" data-tab="{{ block.id }}">
            {{ block.settings.tab_label }}
          </div>
        {% endfor %}
      </div>

      <div class="bestseller-arrows">
        <button class="bestseller-arrow prev" aria-label="Previous">◀</button>
        <button class="bestseller-arrow next" aria-label="Next">▶</button>
      </div>
    </div>

    {% for block in section.blocks %}
      <div class="bestseller-slider-container{% unless forloop.first %} hidden{% endunless %}" id="{{ block.id }}">
        <div class="bestseller-slider">
          {% for product in collections[block.settings.collection].products limit: block.settings.products_limit %}
            <div class="bestseller-card">
              {% if section.settings.show_bestseller_badge %}
                <div class="bestseller-label">{{ section.settings.bestseller_text }}</div>
              {% endif %}
              <a href="{{ product.url }}">
                <img src="{{ product.featured_image | img_url: '600x' }}" alt="{{ product.title }}">
              </a>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endfor %}
  </div>
</section>

{% javascript %}
document.addEventListener('shopify:section:load', initBestseller);
document.addEventListener('DOMContentLoaded', initBestseller);

function initBestseller() {
  const sections = document.querySelectorAll('.bestseller-section');

  sections.forEach(section => {
    const tabs = section.querySelectorAll('.bestseller-tab');
    const sliders = section.querySelectorAll('.bestseller-slider-container');
    const prevBtn = section.querySelector('.bestseller-arrow.prev');
    const nextBtn = section.querySelector('.bestseller-arrow.next');

    let currentTab = section.querySelector('.bestseller-tab.active');
    let currentSlider = section.querySelector(`#${currentTab.dataset.tab}`);
    let position = 0;

    const desktopCols = parseInt(section.dataset.desktopColumns);
    const mobileCols = parseInt(section.dataset.mobileColumns);
    const cardGap = parseInt(section.dataset.cardGap) || 24;

    function visibleCardsCount() {
      return window.innerWidth <= 768 ? mobileCols : desktopCols;
    }

    function updateCardWidths() {
      const visible = visibleCardsCount();
      const sliderContainer = currentSlider;
      const slider = currentSlider.querySelector('.bestseller-slider');
      const cards = slider.querySelectorAll('.bestseller-card');
      
      if (cards.length === 0) return;
      
      // Calculate card width accounting for gaps - FIXED CALCULATION
      const containerWidth = sliderContainer.offsetWidth;
      const totalGap = (visible - 1) * cardGap;
      const cardWidth = (containerWidth - totalGap) / visible;
      
      cards.forEach(card => {
        card.style.width = `${cardWidth}px`;
        card.style.flexShrink = '0';
      });
      
      // Update slider width to accommodate all cards
      const totalWidth = (cardWidth * cards.length) + (cardGap * (cards.length - 1));
      slider.style.width = `${totalWidth}px`;
      
      // Update slider position after resizing
      updateSliderPosition();
    }

    function getMaxPosition() {
      const slider = currentSlider.querySelector('.bestseller-slider');
      const cards = slider.querySelectorAll('.bestseller-card');
      const visible = visibleCardsCount();
      return Math.max(0, cards.length - visible);
    }

    function updateSliderPosition() {
      const slider = currentSlider.querySelector('.bestseller-slider');
      const maxPosition = getMaxPosition();
      
      // Ensure position is within bounds
      position = Math.max(0, Math.min(position, maxPosition));
      
      const visible = visibleCardsCount();
      const containerWidth = currentSlider.offsetWidth;
      const totalGap = (visible - 1) * cardGap;
      const cardWidth = (containerWidth - totalGap) / visible;
      
      // Calculate translation based on actual card width and gap
      const translateX = position * (cardWidth + cardGap);
      slider.style.transform = `translateX(-${translateX}px)`;
      
      // Update arrow states
      updateArrowStates();
    }

    function updateArrowStates() {
      const maxPosition = getMaxPosition();
      prevBtn.classList.toggle('disabled', position === 0);
      nextBtn.classList.toggle('disabled', position >= maxPosition);
    }

    function nextSlide() {
      const maxPosition = getMaxPosition();
      if (position < maxPosition) {
        position++;
        updateSliderPosition();
      }
    }

    function prevSlide() {
      if (position > 0) {
        position--;
        updateSliderPosition();
      }
    }

    // Event listeners
    nextBtn.addEventListener('click', nextSlide);
    prevBtn.addEventListener('click', prevSlide);

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        sliders.forEach(s => s.classList.add('hidden'));
        
        tab.classList.add('active');
        currentTab = tab;
        currentSlider = section.querySelector(`#${tab.dataset.tab}`);
        currentSlider.classList.remove('hidden');
        
        // Reset position and update for new slider
        position = 0;
        updateCardWidths();
        updateSliderPosition();
      });
    });

    // Initialize on load and resize
    function initializeSlider() {
      updateCardWidths();
      updateSliderPosition();
    }

    // Use ResizeObserver for better resize handling
    let resizeObserver;
    if (typeof ResizeObserver !== 'undefined') {
      resizeObserver = new ResizeObserver(() => {
        updateCardWidths();
      });
      resizeObserver.observe(section);
    } else {
      // Fallback for browsers that don't support ResizeObserver
      let resizeTimeout;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          updateCardWidths();
        }, 250);
      });
    }

    // Initialize on load with a small delay to ensure DOM is ready
    setTimeout(() => {
      initializeSlider();
    }, 100);
    
    // Reinitialize when section loads in theme editor
    if (window.Shopify && window.Shopify.designMode) {
      document.addEventListener('shopify:section:select', initializeSlider);
      document.addEventListener('shopify:section:deselect', initializeSlider);
    }
  });
}
{% endjavascript %}

{% schema %}
{
  "name": "Bestseller Slider",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Best Sellers"
    },
    {
      "type": "range",
      "id": "desktop_columns",
      "label": "Products per row (desktop)",
      "min": 2,
      "max": 5,
      "step": 1,
      "default": 4
    },
    {
      "type": "range",
      "id": "mobile_columns",
      "label": "Products per row (mobile)",
      "min": 1,
      "max": 3,
      "step": 1,
      "default": 1
    },
    {
      "type": "range",
      "id": "max_width",
      "label": "Max section width (px)",
      "min": 800,
      "max": 1600,
      "step": 50,
      "default": 1400
    },
    {
      "type": "range",
      "id": "section_padding",
      "label": "Section padding (px)",
      "min": 20,
      "max": 120,
      "step": 10,
      "default": 60
    },
    {
      "type": "checkbox",
      "id": "show_bestseller_badge",
      "label": "Show 'Bestseller' badge",
      "default": true
    },
    {
      "type": "text",
      "id": "bestseller_text",
      "label": "Bestseller badge text",
      "default": "Bestseller"
    },
    {
      "type": "range",
      "id": "card_gap",
      "label": "Space between cards (px)",
      "min": 0,
      "max": 40,
      "step": 2,
      "default": 24
    }
  ],
  "blocks": [
    {
      "type": "collection_tab",
      "name": "Collection Tab",
      "settings": [
        {
          "type": "text",
          "id": "tab_label",
          "label": "Tab Label",
          "default": "Collection"
        },
        {
          "type": "collection",
          "id": "collection",
          "label": "Collection"
        },
        {
          "type": "range",
          "id": "products_limit",
          "label": "Maximum products to show",
          "min": 1,
          "max": 20,
          "step": 1,
          "default": 8
        }
      ]
    }
  ],
  "max_blocks": 6,
  "presets": [
    {
      "name": "Bestseller Slider",
      "category": "Custom Sections",
      "settings": {
        "heading": "Best Sellers",
        "desktop_columns": 4,
        "mobile_columns": 1
      },
      "blocks": [
        { 
          "type": "collection_tab",
          "settings": {
            "tab_label": "Mealtime",
            "products_limit": 8
          }
        },
        { 
          "type": "collection_tab",
          "settings": {
            "tab_label": "Travel",
            "products_limit": 8
          }
        },
        { 
          "type": "collection_tab",
          "settings": {
            "tab_label": "New Arrivals",
            "products_limit": 8
          }
        }
      ]
    }
  ]
}
{% endschema %}
