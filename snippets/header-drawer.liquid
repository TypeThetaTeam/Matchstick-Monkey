{% comment %}
  Custom Mobile Drawer Menu - Accordion Style with Dynamic Images
  Usage: {% render 'header-drawer-accordion' %}
{% endcomment %}

<style>
/* =====================================================
   MOBILE DRAWER - ACCORDION STYLE WITH IMAGES
   ===================================================== */
@media screen and (max-width: 989px) {
  .menu-drawer__navigation .submenu-open {
    visibility: visible !important;
    opacity: 1;
    height: auto;
    pointer-events: auto;
  }
  
  /* Ensure menu drawer has proper scroll */
  .menu-drawer {
    position: fixed !important;
    top: 70px !important;
    left: 0 !important;
    width: 100% !important;
    height: 90vh !important;
    overflow: hidden !important;
    display: flex !important;
    flex-direction: column !important;
  }
  
  .menu-drawer__inner-container {
    flex: 1 !important;
    overflow-y: auto !important;
    overflow-x: hidden !important;
    -webkit-overflow-scrolling: touch !important;
    transition: padding-bottom 0.3s ease !important;
    padding-bottom: 0 !important;
  }
  
  .menu-drawer__inner-container.has-images {
    padding-bottom: 240px !important; /* Adjusted for side-by-side images */
  }
  
  /* Accordion Menu Item */
  .accordion-drawer__item {
    border-bottom: 1px solid rgba(0, 0, 0, 0.08);
  }
  
  /* Main Menu Summary (with arrow) */
  .accordion-drawer__summary {
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    padding: 1rem 1.5rem !important;
    cursor: pointer !important;
    list-style: none !important;
    font-size: 1rem !important;
    color: #2c2c2c !important;
    background: transparent !important;
    transition: background 0.2s ease !important;
  }
  
  .accordion-drawer__summary::-webkit-details-marker {
    display: none !important;
  }
  
  .accordion-drawer__summary:hover {
    background: rgba(0, 0, 0, 0.02) !important;
  }
  
  /* Arrow Icon */
  .accordion-drawer__arrow {
    width: 10px !important;
    height: 10px !important;
    border-right: 2px solid currentColor !important;
    border-bottom: 2px solid currentColor !important;
    transform: rotate(45deg) !important;
    transition: transform 0.3s ease !important;
    flex-shrink: 0 !important;
  }
  
  details[open] > .accordion-drawer__summary .accordion-drawer__arrow {
    transform: rotate(-135deg) !important;
  }
  
  /* Dropdown Content */
  .accordion-drawer__content {
    padding: 0 1.5rem 1rem !important;
    background: rgba(0, 0, 0, 0.02) !important;
  }
  
  /* Green Heading in Dropdown */
  .accordion-drawer__heading {
    font-family: Georgia, 'Times New Roman', serif !important;
    font-size: 1.25rem !important;
    font-weight: 400 !important;
    color: #00b8a9 !important;
    margin: 1rem 0 0.75rem 0 !important;
    line-height: 1.3 !important;
  }
  
  /* Navigation Links */
  .accordion-drawer__nav-list {
    list-style: none !important;
    padding: 0 !important;
    margin: 0 0 1rem 0 !important;
  }
  
  .accordion-drawer__nav-item {
    margin: 0 !important;
  }
  
  .accordion-drawer__nav-link {
    display: flex !important;
    align-items: center !important;
    padding: 0.6rem 0 !important;
    color: #2c2c2c !important;
    text-decoration: none !important;
    font-size: 0.95rem !important;
    min-height: 44px !important;
    transition: color 0.2s ease !important;
  }
  
  .accordion-drawer__nav-link:hover {
    color: #00b8a9 !important;
  }
  
  /* Sub-menu items (level 3) */
  .accordion-drawer__sub-item {
    padding-left: 1rem !important;
  }
  
  .accordion-drawer__sub-summary {
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    padding: 0.6rem 0 !important;
    cursor: pointer !important;
    list-style: none !important;
    font-size: 0.95rem !important;
    color: #2c2c2c !important;
    min-height: 44px !important;
  }
  
  .accordion-drawer__sub-summary::-webkit-details-marker {
    display: none !important;
  }
  
  .accordion-drawer__sub-arrow {
    width: 8px !important;
    height: 8px !important;
    border-right: 2px solid currentColor !important;
    border-bottom: 2px solid currentColor !important;
    transform: rotate(45deg) !important;
    transition: transform 0.3s ease !important;
    margin-left: 0.5rem !important;
    flex-shrink: 0 !important;
  }
  
  details[open] > .accordion-drawer__sub-summary .accordion-drawer__sub-arrow {
    transform: rotate(-135deg) !important;
  }
  
  .accordion-drawer__sub-content {
    padding-left: 1rem !important;
  }
  
  .accordion-drawer__grandchild-link {
    display: flex !important;
    align-items: center !important;
    padding: 0.5rem 0 !important;
    color: #666 !important;
    text-decoration: none !important;
    font-size: 0.9rem !important;
    min-height: 44px !important;
    transition: color 0.2s ease !important;
  }
  
  .accordion-drawer__grandchild-link:hover {
    color: #00b8a9 !important;
  }
  
  /* IMAGES SECTION - AT THE BOTTOM */
  .accordion-drawer__images-container {
    position: fixed !important;
    bottom: 0 !important;
    left: 0 !important;
    right: 0 !important;
    background: #f5f1ed !important;
    padding: 0.75rem !important;
    border-top: 1px solid rgba(0, 0, 0, 0.1) !important;
    z-index: 9 !important;
    display: none !important;
    max-height: 220px !important;
    overflow-y: auto !important;
    overflow-x: hidden !important;
    -webkit-overflow-scrolling: touch !important;
    transition: transform 0.3s ease !important;
  }
  
  .accordion-drawer__images-container.active {
    display: block !important;
  }
  
  .accordion-drawer__images-wrapper {
    display: flex !important;
    flex-direction: row !important;
    gap: 0.5rem !important;
    width: 100% !important;
  }
  
  /* Image groups visibility */
  .accordion-drawer__images-group {
    display: none !important;
    flex-direction: row !important;
    gap: 0.5rem !important;
    width: 100% !important;
  }
  
  .accordion-drawer__images-group.active {
    display: flex !important;
  }
  
  /* Image Block - Side by Side */
  .accordion-drawer__image-block {
    position: relative !important;
    overflow: hidden !important;
    background: #a8c9cd !important;
    height: 200px !important;
    flex: 1 !important;
    min-width: 0 !important;
    border-radius: 4px !important;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;
  }
  
  .accordion-drawer__image-link {
    display: block !important;
    height: 100% !important;
    text-decoration: none !important;
  }
  
  .accordion-drawer__image-wrapper {
    position: relative !important;
    width: 100% !important;
    height: 100% !important;
    overflow: hidden !important;
  }
  
  .accordion-drawer__image-wrapper img {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
    display: block !important;
  }
  
  /* Image Overlay - TOP LEFT */
  .accordion-drawer__image-overlay {
    position: absolute !important;
    top: 0.75rem !important;
    left: 0.75rem !important;
    right: 0.75rem !important;
    z-index: 2 !important;
    color: #6b7280 !important;
    text-align: left !important;
  }
  
  .accordion-drawer__image-title {
    font-size: 1rem !important;
    font-weight: 600 !important;
    margin: 0 0 0.25rem 0 !important;
    color: #6b7280 !important;
    text-shadow: 0 1px 3px rgba(255, 255, 255, 0.5) !important;
    line-height: 1.2 !important;
  }
  
  .accordion-drawer__image-subtitle {
    font-size: 0.75rem !important;
    margin: 0 !important;
    color: #6b7280 !important;
    text-decoration: underline !important;
    text-shadow: 0 1px 3px rgba(255, 255, 255, 0.5) !important;
    line-height: 1.4 !important;
  }
}

@media screen and (min-width: 990px) {
  .accordion-drawer__item,
  .accordion-drawer__images-container {
    display: none !important;
  }
}
</style>

<header-drawer data-breakpoint="tablet">
  <details id="Details-menu-drawer-container" class="menu-drawer-container">
    <summary
      class="header__icon header__icon--menu header__icon--summary link focus-inset"
      aria-label="{{ 'sections.header.menu' | t }}"
    >
      <span>
        {{- 'icon-hamburger.svg' | inline_asset_content -}}
        {{- 'icon-close.svg' | inline_asset_content -}}
      </span>
    </summary>
    <div id="menu-drawer" class="gradient menu-drawer motion-reduce color-{{ section.settings.menu_color_scheme }}">
      <div class="menu-drawer__inner-container">
        <div class="menu-drawer__navigation-container">
          <nav class="menu-drawer__navigation">
            <ul class="menu-drawer__menu has-submenu list-menu" role="list">
              {%- for link in section.settings.menu.links -%}
                <li>
                  {%- if link.links != blank -%}
                    {%- assign menu_handle = link.title | handleize -%}
                    
                    <div class="accordion-drawer__item">
                      <details class="accordion-drawer__details" data-menu-handle="{{ menu_handle }}">
                        <summary class="accordion-drawer__summary">
                          <span>{{ link.title | escape }}</span>
                          <span class="accordion-drawer__arrow"></span>
                        </summary>
                        
                        <div class="accordion-drawer__content">
                          {%- comment -%} Find and display heading {%- endcomment -%}
                          {%- for block in section.blocks -%}
                            {%- if block.type == 'mega_menu_images' -%}
                              {%- assign block_menu = block.settings.menu_item | handleize -%}
                              {%- if block_menu == menu_handle and block.settings.menu_heading != blank -%}
                                <h3 class="accordion-drawer__heading">{{ block.settings.menu_heading }}</h3>
                              {%- endif -%}
                            {%- endif -%}
                          {%- endfor -%}
                          
                          <ul class="accordion-drawer__nav-list">
                            {%- for childlink in link.links -%}
                              <li class="accordion-drawer__nav-item">
                                {%- if childlink.links == blank -%}
                                  <a href="{{ childlink.url }}" class="accordion-drawer__nav-link">
                                    {{ childlink.title | escape }}
                                  </a>
                                {%- else -%}
                                  <div class="accordion-drawer__sub-item">
                                    <details class="accordion-drawer__sub-details">
                                      <summary class="accordion-drawer__sub-summary">
                                        <span>{{ childlink.title | escape }}</span>
                                        <span class="accordion-drawer__sub-arrow"></span>
                                      </summary>
                                      <div class="accordion-drawer__sub-content">
                                        {%- for grandchildlink in childlink.links -%}
                                          <a href="{{ grandchildlink.url }}" class="accordion-drawer__grandchild-link">
                                            {{ grandchildlink.title | escape }}
                                          </a>
                                        {%- endfor -%}
                                      </div>
                                    </details>
                                  </div>
                                {%- endif -%}
                              </li>
                            {%- endfor -%}
                          </ul>
                        </div>
                      </details>
                    </div>
                    
                  {%- else -%}
                    <div class="accordion-drawer__item">
                      <a href="{{ link.url }}" class="accordion-drawer__summary" style="text-decoration: none;">
                        <span>{{ link.title | escape }}</span>
                      </a>
                    </div>
                  {%- endif -%}
                </li>
              {%- endfor -%}
            </ul>
          </nav>
        </div>
      </div>
      
      {%- comment -%} IMAGES CONTAINER - FIXED AT BOTTOM {%- endcomment -%}
      <div class="accordion-drawer__images-container" id="drawerImagesContainer">
        <div class="accordion-drawer__images-wrapper">
          {%- for link in section.settings.menu.links -%}
            {%- if link.links != blank -%}
              {%- assign menu_handle = link.title | handleize -%}
              
              {%- for block in section.blocks -%}
                {%- if block.type == 'mega_menu_images' -%}
                  {%- assign block_menu = block.settings.menu_item | handleize -%}
                  {%- if block_menu == menu_handle -%}
                    
                    <div class="accordion-drawer__images-group" data-menu="{{ menu_handle }}">
                      {%- if block.settings.image_1 != blank -%}
                        <div class="accordion-drawer__image-block">
                          {%- if block.settings.link_1 != blank -%}
                            <a href="{{ block.settings.link_1 }}" class="accordion-drawer__image-link">
                          {%- endif -%}
                          
                          <div class="accordion-drawer__image-wrapper">
                            {{ block.settings.image_1 | image_url: width: 600 | image_tag: loading: 'lazy', width: 300, height: 200 }}
                            
                            {%- if block.settings.heading_1 != blank or block.settings.subheading_1 != blank -%}
                              <div class="accordion-drawer__image-overlay">
                                {%- if block.settings.heading_1 != blank -%}
                                  <p class="accordion-drawer__image-title">{{ block.settings.heading_1 }}</p>
                                {%- endif -%}
                                {%- if block.settings.subheading_1 != blank -%}
                                  <p class="accordion-drawer__image-subtitle">{{ block.settings.subheading_1 }}</p>
                                {%- endif -%}
                              </div>
                            {%- endif -%}
                          </div>
                          
                          {%- if block.settings.link_1 != blank -%}
                            </a>
                          {%- endif -%}
                        </div>
                      {%- endif -%}
                      
                      {%- if block.settings.image_2 != blank -%}
                        <div class="accordion-drawer__image-block">
                          {%- if block.settings.link_2 != blank -%}
                            <a href="{{ block.settings.link_2 }}" class="accordion-drawer__image-link">
                          {%- endif -%}
                          
                          <div class="accordion-drawer__image-wrapper">
                            {{ block.settings.image_2 | image_url: width: 600 | image_tag: loading: 'lazy', width: 300, height: 200 }}
                            
                            {%- if block.settings.heading_2 != blank or block.settings.subheading_2 != blank -%}
                              <div class="accordion-drawer__image-overlay">
                                {%- if block.settings.heading_2 != blank -%}
                                  <p class="accordion-drawer__image-title">{{ block.settings.heading_2 }}</p>
                                {%- endif -%}
                                {%- if block.settings.subheading_2 != blank -%}
                                  <p class="accordion-drawer__image-subtitle">{{ block.settings.subheading_2 }}</p>
                                {%- endif -%}
                              </div>
                            {%- endif -%}
                          </div>
                          
                          {%- if block.settings.link_2 != blank -%}
                            </a>
                          {%- endif -%}
                        </div>
                      {%- endif -%}
                    </div>
                    
                  {%- endif -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}
          {%- endfor -%}
        </div>
      </div>
      
    </div>
  </details>
</header-drawer>

<script>
  (function () {
    function initMobileDrawerImages() {
      if (!window.matchMedia('(max-width: 989px)').matches) return;

      const accordionDetails = document.querySelectorAll('.accordion-drawer__details');
      const imagesContainer = document.getElementById('drawerImagesContainer');
      const menuInnerContainer = document.querySelector('.menu-drawer__inner-container');
      const mainDrawer = document.getElementById('Details-menu-drawer-container');

      if (!accordionDetails.length || !imagesContainer) return;

      // Prevent double-binding when section reloads
      accordionDetails.forEach((details) => {
        if (details.dataset.imagesBound === 'true') return;
        details.dataset.imagesBound = 'true';

        details.addEventListener('toggle', function () {
          const allImageGroups = document.querySelectorAll('.accordion-drawer__images-group');

          if (this.open) {
            // Close other accordions
            accordionDetails.forEach((other) => {
              if (other !== this) other.open = false;
            });

            // Hide all image groups
            allImageGroups.forEach((group) => group.classList.remove('active'));

            // Show images for this menu handle
            const menuHandle = this.getAttribute('data-menu-handle');
            const currentGroup = document.querySelector(
              '.accordion-drawer__images-group[data-menu="' + menuHandle + '"]'
            );

            if (currentGroup) {
              currentGroup.classList.add('active');
              imagesContainer.classList.add('active');
              if (menuInnerContainer) menuInnerContainer.classList.add('has-images');
            } else {
              imagesContainer.classList.remove('active');
              if (menuInnerContainer) menuInnerContainer.classList.remove('has-images');
            }
          } else {
            // Hide images when closed
            imagesContainer.classList.remove('active');
            if (menuInnerContainer) menuInnerContainer.classList.remove('has-images');
            allImageGroups.forEach((group) => group.classList.remove('active'));
          }
        });
      });

      if (mainDrawer && mainDrawer.dataset.imagesBound !== 'true') {
        mainDrawer.dataset.imagesBound = 'true';

        // Hide images when main drawer closes
        mainDrawer.addEventListener('toggle', function () {
          if (!this.open) {
            imagesContainer.classList.remove('active');
            if (menuInnerContainer) menuInnerContainer.classList.remove('has-images');

            document
              .querySelectorAll('.accordion-drawer__images-group')
              .forEach((group) => group.classList.remove('active'));
            
            // Close all accordions
            document.querySelectorAll('.accordion-drawer__details').forEach((details) => {
              details.open = false;
            });
          }
        });
      }
    }

    // Run now or on DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initMobileDrawerImages);
    } else {
      initMobileDrawerImages();
    }

    // Run again when Shopify re-renders sections (theme editor)
    document.addEventListener('shopify:section:load', initMobileDrawerImages);
  })();
</script>