{% comment %}
  Custom Mega Menu - FIXED VERSION
  - Full width dropdown
  - Left: Navigation links
  - Right: Two images side-by-side
{% endcomment %}

<nav class="header__inline-menu">
  <ul class="list-menu list-menu--inline" role="list">
    {%- for link in section.settings.menu.links -%}
      <li class="list-menu-item">
        {%- if link.links != blank -%}
          <header-menu class="header__menu-item">
            <div class="mega-menu-trigger">
              <span class="header__menu-item list-menu__item link focus-inset"{%- if link.child_active %} class="header__active-menu-item"{% endif %}>
                {{- link.title | escape -}}
                <span class="icon-caret">
                  <svg aria-hidden="true" focusable="false" viewBox="0 0 10 6">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M9.354.646a.5.5 0 00-.708 0L5 4.293 1.354.646a.5.5 0 00-.708.708l4 4a.5.5 0 00.708 0l4-4a.5.5 0 000-.708z" fill="currentColor"></path>
                  </svg>
                </span>
              </span>
            </div>
            
            <div class="mega-menu__content color-{{ section.settings.menu_color_scheme }}">
              {%- assign menu_handle = link.title | handleize -%}
              
              <div class="mega-menu__inner">
                <div class="mega-menu__wrapper page-width">
                  {%- comment -%} LEFT: Navigation Links {%- endcomment -%}
                  <div class="mega-menu__navigation">
                    {%- for block in section.blocks -%}
                      {%- if block.type == 'mega_menu_images' -%}
                        {%- assign block_menu_handle = block.settings.menu_item | handleize -%}
                        {%- if block_menu_handle == menu_handle and block.settings.menu_heading != blank -%}
                          <h2 class="mega-menu__heading">{{ block.settings.menu_heading }}</h2>
                        {%- endif -%}
                      {%- endif -%}
                    {%- endfor -%}
                    
                    <ul class="mega-menu__list" role="list">
                      {%- for childlink in link.links -%}
                        <li class="mega-menu__list-item">
                          <a href="{{ childlink.url }}" class="mega-menu__link mega-menu__link--level-2"{%- if childlink.current %} aria-current="page"{% endif %}>
                            {{ childlink.title | escape }}
                          </a>
                          
                          {%- if childlink.links != blank -%}
                            <ul class="mega-menu__sublist" role="list">
                              {%- for grandchildlink in childlink.links -%}
                                <li class="mega-menu__sublist-item">
                                  <a href="{{ grandchildlink.url }}" class="mega-menu__link mega-menu__link--level-3"{%- if grandchildlink.current %} aria-current="page"{% endif %}>
                                    {{ grandchildlink.title | escape }}
                                  </a>
                                </li>
                              {%- endfor -%}
                            </ul>
                          {%- endif -%}
                        </li>
                      {%- endfor -%}
                    </ul>
                  </div>
                  
                  {%- comment -%} RIGHT: Images Side-by-Side {%- endcomment -%}
                  <div class="mega-menu__images">
                    {%- assign image_found = false -%}
                    {%- for block in section.blocks -%}
                      {%- if block.type == 'mega_menu_images' -%}
                        {%- assign block_menu_handle = block.settings.menu_item | handleize -%}
                        {%- if block_menu_handle == menu_handle -%}
                          {%- assign image_found = true -%}
                          
                          {%- if block.settings.image_1 != blank -%}
                            <div class="mega-menu__image-block">
                              {%- if block.settings.link_1 != blank -%}<a href="{{ block.settings.link_1 }}" class="mega-menu__image-link">{%- endif -%}
                                <div class="mega-menu__image-wrapper">
                                  <img
                                    src="{{ block.settings.image_1 | image_url: width: 800 }}"
                                    alt="{{ block.settings.image_1.alt | default: block.settings.heading_1 | escape }}"
                                    loading="lazy"
                                    width="400"
                                    height="400"
                                  >
                                  {%- if block.settings.heading_1 != blank or block.settings.subheading_1 != blank -%}
                                    <div class="mega-menu__image-overlay">
                                      {%- if block.settings.heading_1 != blank -%}
                                        <h3 class="mega-menu__image-title">{{ block.settings.heading_1 }}</h3>
                                      {%- endif -%}
                                      {%- if block.settings.subheading_1 != blank -%}
                                        <p class="mega-menu__image-subtitle">{{ block.settings.subheading_1 }}</p>
                                      {%- endif -%}
                                    </div>
                                  {%- endif -%}
                                </div>
                              {%- if block.settings.link_1 != blank -%}</a>{%- endif -%}
                            </div>
                          {%- endif -%}
                          
                          {%- if block.settings.image_2 != blank -%}
                            <div class="mega-menu__image-block">
                              {%- if block.settings.link_2 != blank -%}<a href="{{ block.settings.link_2 }}" class="mega-menu__image-link">{%- endif -%}
                                <div class="mega-menu__image-wrapper">
                                  <img
                                    src="{{ block.settings.image_2 | image_url: width: 800 }}"
                                    alt="{{ block.settings.image_2.alt | default: block.settings.heading_2 | escape }}"
                                    loading="lazy"
                                    width="400"
                                    height="400"
                                  >
                                  {%- if block.settings.heading_2 != blank or block.settings.subheading_2 != blank -%}
                                    <div class="mega-menu__image-overlay">
                                      {%- if block.settings.heading_2 != blank -%}
                                        <h3 class="mega-menu__image-title">{{ block.settings.heading_2 }}</h3>
                                      {%- endif -%}
                                      {%- if block.settings.subheading_2 != blank -%}
                                        <p class="mega-menu__image-subtitle">{{ block.settings.subheading_2 }}</p>
                                      {%- endif -%}
                                    </div>
                                  {%- endif -%}
                                </div>
                              {%- if block.settings.link_2 != blank -%}</a>{%- endif -%}
                            </div>
                          {%- endif -%}
                        {%- endif -%}
                      {%- endif -%}
                    {%- endfor -%}
                    
                    {%- unless image_found -%}
                      <div class="mega-menu__placeholder">
                        <p>Add images for "{{ link.title }}"</p>
                      </div>
                    {%- endunless -%}
                  </div>
                </div>
              </div>
            </div>
          </header-menu>
        {%- else -%}
          <a href="{{ link.url }}" class="header__menu-item list-menu__item link link--text focus-inset"{%- if link.current %} aria-current="page"{% endif %}>
            <span{%- if link.current %} class="header__active-menu-item"{% endif %}>{{- link.title | escape -}}</span>
          </a>
        {%- endif -%}
      </li>
    {%- endfor -%}
  </ul>
</nav>

<script>
(function() {
  if (customElements.get('header-menu')) return;
  
  class HeaderMenu extends HTMLElement {
    constructor() {
      super();
      this.trigger = this.querySelector('.mega-menu-trigger');
      this.content = this.querySelector('.mega-menu__content');
      this.closeTimeout = null;
      
      this.addEventListener('mouseenter', () => this.open());
      this.addEventListener('mouseleave', () => this.delayedClose());
      this.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') this.close();
      });
    }
    
    open() {
      if (this.closeTimeout) clearTimeout(this.closeTimeout);
      document.querySelectorAll('header-menu').forEach(m => {
        if (m !== this) m.close();
      });
      this.classList.add('is-open');
      this.content?.classList.add('is-visible');
    }
    
    close() {
      this.classList.remove('is-open');
      this.content?.classList.remove('is-visible');
    }
    
    delayedClose() {
      this.closeTimeout = setTimeout(() => this.close(), 150);
    }
  }
  
  customElements.define('header-menu', HeaderMenu);
})();
</script>
