{%- comment -%}
  Buy Buttons - Add to Cart + Dynamic Checkout
{%- endcomment -%}

<div class="product-buy-buttons" {{ block.shopify_attributes }}>
  {%- form 'product', product, id: product_form_id, novalidate: 'novalidate' -%}
    
    <div class="buy-buttons-wrapper">
      <button
        type="submit"
        name="add"
        class="btn btn--primary btn--add-to-cart"
        {% unless current_variant.available %}disabled{% endunless %}
        data-add-to-cart-button
      >
        <span class="btn__text">
          {%- if current_variant.available -%}
            {%- if block.settings.button_text != blank -%}
              {{ block.settings.button_text }}
            {%- else -%}
              {{ 'products.product.add_to_cart' | t }}
            {%- endif -%}
            
            {%- if block.settings.show_price_in_button -%}
              <span class="btn__price-separator">â€¢</span>
              <span class="btn__price" data-button-price>
                {{ current_variant.price | money }}
              </span>
            {%- endif -%}
          {%- else -%}
            {%- if block.settings.soldout_text != blank -%}
              {{ block.settings.soldout_text }}
            {%- else -%}
              {{ 'products.product.sold_out' | t }}
            {%- endif -%}
          {%- endif -%}
        </span>
        
        <span class="btn__spinner" hidden>
          <svg class="spinner" viewBox="0 0 50 50">
            <circle class="spinner__path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle>
          </svg>
        </span>
      </button>

      {%- if block.settings.show_dynamic_checkout -%}
        <div class="dynamic-checkout-buttons">
          {{ form | payment_button }}
        </div>
      {%- endif -%}
    </div>

    {%- comment -%} Error message container {%- endcomment -%}
    <div class="product-form__error-message" role="alert" hidden data-error-message>
      <span class="error-message__icon">
        {%- render 'icon-error' -%}
      </span>
      <span class="error-message__text"></span>
    </div>

  {%- endform -%}
</div>

<style>
  .btn--add-to-cart {
    position: relative;
    transition: background-color 0.2s ease, transform 0.1s ease;
  }
  
  .btn--add-to-cart:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  
  .btn--add-to-cart.is-loading .btn__text {
    opacity: 0;
  }
  
  .btn--add-to-cart.is-loading .btn__spinner {
    display: block;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }
  
  .btn__price-separator {
    margin: 0 0.5rem;
  }
  
  .spinner {
    animation: rotate 2s linear infinite;
    width: 24px;
    height: 24px;
  }
  
  .spinner__path {
    stroke: currentColor;
    stroke-linecap: round;
    animation: dash 1.5s ease-in-out infinite;
  }
  
  @keyframes rotate {
    100% { transform: rotate(360deg); }
  }
  
  @keyframes dash {
    0% {
      stroke-dasharray: 1, 150;
      stroke-dashoffset: 0;
    }
    50% {
      stroke-dasharray: 90, 150;
      stroke-dashoffset: -35;
    }
    100% {
      stroke-dasharray: 90, 150;
      stroke-dashoffset: -124;
    }
  }

  .product-form__error-message {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 1rem;
    padding: 0.75rem 1rem;
    background-color: #fee;
    border: 1px solid #fcc;
    border-radius: 8px;
    color: #c00;
  }
  
  .error-message__icon {
    flex-shrink: 0;
  }

  .dynamic-checkout-buttons {
    margin-top: 0.75rem;
  }

  @media (max-width: 989px) {
    .buy-buttons-wrapper {
      display: flex;
      flex-direction: column-reverse;
      gap: 0.75rem;
    }
  }
</style>